name: Optional CI Test Runs (5x)

on:
    workflow_dispatch:
        inputs:
            branch:
                description: 'Branch name to test (e.g. main)'
                required: true
                type: string
                default: main

permissions:
    contents: read

jobs:
    tests:
        name: Playwright run ${{ matrix.run }} of 5
        runs-on: ubuntu-22.04
        timeout-minutes: 20
        strategy:
            fail-fast: false
            matrix:
                run: [1, 2, 3, 4, 5]
        steps:
            - uses: actions/checkout@v4
              with:
                  ref: ${{ inputs.branch }}
            - name: Validate branch input
              run: |
                  branch="${{ inputs.branch }}"
                  branch="${branch#refs/heads/}"
                  git ls-remote --exit-code --heads origin "refs/heads/${branch}"
            - uses: actions/setup-node@v4
              with:
                  node-version: 22
                  cache: 'npm'
            - run: npm run install-ci
            - name: Install Playwright Browsers
              run: npx playwright install --with-deps chromium
            - name: Run Playwright tests (attempt ${{ matrix.run }})
              run: xvfb-run --auto-servernum -- npm run playwright
